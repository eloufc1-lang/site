<!-- MENSAGEM DE FEEDBACK -->
<p id="msg" class="alerta"></p>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const API = "https://script.google.com/macros/s/AKfycbxr6OZ6IiufWCZNfv49p6pLpeyw_NhCapUVRxxKZGLBeMRz9dBGiB_YTPyYdy1fSQ0JMw/exec";

  let usuarios = [];
  let usuarioLogado = null;

  const msg = document.getElementById("msg");
  const btnLogin = document.getElementById("btnLogin");

  function mostrarMsg(texto) {
    msg.innerText = texto;
  }

  /* ===== CARREGAR USUÁRIOS ===== */
  btnLogin.disabled = true;
  btnLogin.innerText = "Carregando...";

  fetch(API + "?acao=usuarios")
    .then(r => r.json())
    .then(d => {
      usuarios = d;
      btnLogin.disabled = false;
      btnLogin.innerText = "Entrar";
    })
    .catch(err => {
      mostrarMsg("Erro ao carregar usuários");
      console.error(err);
    });

  /* ===== LOGIN ===== */
  window.login = function () {
    const u = document.getElementById("usuario").value;
    const s = document.getElementById("senha").value;

    const encontrado = usuarios.find(x => x.usuario === u && x.senha === s);

    if (!encontrado) {
      mostrarMsg("Usuário ou senha inválidos");
      return;
    }

    mostrarMsg("");
    usuarioLogado = encontrado;
    sessionStorage.setItem("usuario", JSON.stringify(encontrado));
    mostrarSistema();
  };

  function mostrarSistema() {
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("sistema").classList.remove("hidden");

    const u = JSON.parse(sessionStorage.getItem("usuario"));
    usuarioLogado = u;

    if (u.perfil === "admin") {
      document.getElementById("adminArea").classList.remove("hidden");
    } else {
      const prof = document.getElementById("professor");
      prof.value = u.nome;
      prof.disabled = true;
    }

    carregarFaltas();
  }

  window.logout = function () {
    sessionStorage.clear();
    location.reload();
  };

  if (sessionStorage.getItem("usuario")) {
    mostrarSistema();
  }

  /* ===== REGISTRAR FALTA ===== */
  document.getElementById("formFalta").addEventListener("submit", e => {
    e.preventDefault();

    const dados = {
      professor: professor.value,
      disciplina: disciplina.value,
      data: data.value,
      motivo: motivo.value,
      substituto: substituto.value
    };

    fetch(API, {
      method: "POST",
      body: JSON.stringify(dados)
    }).then(() => {
      mostrarMsg("Falta registrada com sucesso!");
      e.target.reset();
      if (usuarioLogado.perfil === "professor") {
        professor.value = usuarioLogado.nome;
      }
      carregarFaltas();
    });
  });

  /* ===== LISTAR FALTAS ===== */
  function carregarFaltas() {
    fetch(API + "?acao=faltas")
      .then(r => r.json())
      .then(d => {
        listaFaltas.innerHTML = "";
        d.forEach(f => {
          listaFaltas.innerHTML += `
            <tr>
              <td>${f.professor}</td>
              <td>${f.disciplina}</td>
              <td>${f.data}</td>
              <td>${f.motivo}</td>
              <td>${f.substituto}</td>
            </tr>
          `;
        });
      });
  }

  /* ===== ADMIN ===== */
  window.criarUsuario = function () {
    const dados = {
      acao: "criarUsuario",
      usuario: novoUsuario.value,
      senha: novaSenha.value,
      perfil: novoPerfil.value,
      nome: novoNome.value
    };

    fetch(API, {
      method: "POST",
      body: JSON.stringify(dados)
    }).then(() => {
      mostrarMsg("Usuário criado com sucesso!");
      location.reload();
    });
  };

});
</script>
